#!/bin/bash
# Git commit message validation hook
# Format: [emoji] type: subject
#
#         - change 1
#         - change 2

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

commit_msg_file=$1
commit_msg=$(cat "$commit_msg_file")

# Skip validation for merge commits
if [[ "$commit_msg" =~ ^Merge ]]; then
    exit 0
fi

# Define valid types
valid_types="feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert"

# Extract first line (subject)
subject=$(echo "$commit_msg" | head -n 1)

# List of valid emojis
valid_emojis="âœ¨|ğŸ›|ğŸ“|ğŸ’„|â™»ï¸|âš¡|âœ…|ğŸ“¦|ğŸ‘·|ğŸ”§|âª"

# Check if message starts with valid emoji
if ! echo "$subject" | grep -qE "^($valid_emojis) "; then
    echo -e "${RED}âŒ é”™è¯¯: æäº¤ä¿¡æ¯å¿…é¡»ä»¥ emoji å¼€å¤´${NC}"
    echo ""
    echo -e "${YELLOW}æ­£ç¡®æ ¼å¼:${NC}"
    echo "  âœ¨ feat: æ·»åŠ ç”¨æˆ·è®¤è¯åŠŸèƒ½"
    echo ""
    echo "  - æ·»åŠ  JWT è®¤è¯ä¸­é—´ä»¶"
    echo "  - å®ç°ç™»å½•å’Œæ³¨å†Œæ¥å£"
    echo ""
    echo -e "${YELLOW}å¯ç”¨çš„ emoji å’Œç±»å‹:${NC}"
    echo "  âœ¨ feat     - æ–°åŠŸèƒ½"
    echo "  ğŸ› fix      - Bug ä¿®å¤"
    echo "  ğŸ“ docs     - æ–‡æ¡£æ›´æ–°"
    echo "  ğŸ’„ style    - ä»£ç æ ¼å¼"
    echo "  â™»ï¸ refactor - é‡æ„"
    echo "  âš¡ perf     - æ€§èƒ½ä¼˜åŒ–"
    echo "  âœ… test     - æµ‹è¯•"
    echo "  ğŸ“¦ build    - æ„å»º"
    echo "  ğŸ‘· ci       - CI/CD"
    echo "  ğŸ”§ chore    - å…¶ä»–"
    echo "  âª revert   - å›æ»š"
    exit 1
fi

# Extract type and message after emoji
rest=$(echo "$subject" | sed -E "s/^($valid_emojis) //")

# Check if format is: type: message
if [[ ! "$rest" =~ ^($valid_types):\ .+ ]]; then
    echo -e "${RED}âŒ é”™è¯¯: æäº¤ä¿¡æ¯æ ¼å¼ä¸æ­£ç¡®${NC}"
    echo ""
    echo -e "ä½ çš„æäº¤ä¿¡æ¯: ${YELLOW}$subject${NC}"
    echo ""
    echo -e "${YELLOW}æ­£ç¡®æ ¼å¼:${NC}"
    echo "  emoji type: subject"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  âœ¨ feat: æ·»åŠ è§†é¢‘æ¨èç®—æ³•"
    echo "  ğŸ› fix: ä¿®å¤è¯„è®ºç‚¹èµé‡å¤é—®é¢˜"
    echo "  ğŸ“ docs: æ›´æ–° API æ–‡æ¡£"
    echo ""
    echo -e "${YELLOW}æœ‰æ•ˆçš„ç±»å‹:${NC}"
    echo "  feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert"
    exit 1
fi

# Extract the type
type=$(echo "$rest" | cut -d':' -f1)

# Check if subject is too long
subject_length=${#rest}
if [ $subject_length -gt 72 ]; then
    echo -e "${YELLOW}âš ï¸  è­¦å‘Š: æäº¤ä¿¡æ¯ä¸»é¢˜è¿‡é•¿ ($subject_length å­—ç¬¦ï¼Œå»ºè®® â‰¤ 72)${NC}"
fi

# Check if there's a body with changes list (optional)
body=$(echo "$commit_msg" | tail -n +3)
if [[ -n "$body" ]]; then
    # Check if body contains bullet points
    if [[ ! "$body" =~ ^[[:space:]]*- ]]; then
        echo -e "${YELLOW}âš ï¸  æç¤º: å»ºè®®ä½¿ç”¨ - å¼€å¤´åˆ—å‡ºè¯¦ç»†ä¿®æ”¹${NC}"
        echo ""
        echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
        echo "  [âœ¨] feat: æ·»åŠ ç›´æ’­åŠŸèƒ½"
        echo ""
        echo "  - å®ç°ç›´æ’­æ¨æµæ¥å£"
        echo "  - æ·»åŠ ç›´æ’­é—´ç®¡ç†åŠŸèƒ½"
        echo "  - é›†æˆ WebRTC æ”¯æŒ"
    fi
fi

# Success
echo -e "${GREEN}âœ… æäº¤ä¿¡æ¯æ ¼å¼æ­£ç¡®${NC}"
exit 0
