# WebRTC 测试页面说明

## webrtc-broadcaster.html

这是一个用于测试 Ion SFU 屏幕录制推流的 HTML 页面。

### 功能特性

- 📹 **屏幕录制**: 使用 `getDisplayMedia` API 捕获屏幕内容
- 🎵 **系统音频**: 支持共享系统音频（需要用户选择）
- 🎤 **麦克风备选**: 如果没有系统音频，可以使用麦克风音频
- 📊 **实时统计**: 显示视频码率、音频码率、丢包率、延迟等信息
- 🔄 **WebRTC 连接**: 通过 Ion SFU 实现媒体流转发

### 使用步骤

1. **启动后端服务**
   ```bash
   go run ./cmd/server/main.go
   ```

2. **确保 Ion SFU 容器运行**
   ```bash
   docker ps | grep ion-sfu
   # 应该看到 microvibe-ion-sfu 容器在运行
   ```

3. **打开测试页面**
   - 直接在浏览器中打开 `examples/webrtc-broadcaster.html`
   - 或者通过 HTTP 服务器访问（推荐）：
     ```bash
     # 使用 Python 启动简单 HTTP 服务器
     cd examples
     python3 -m http.server 8000
     # 然后访问 http://localhost:8000/webrtc-broadcaster.html
     ```

4. **开始屏幕录制**
   - 点击"🖥️ 开始屏幕录制"按钮
   - 浏览器会弹出屏幕选择对话框
   - 选择要共享的屏幕、窗口或标签页
   - （可选）勾选"共享音频"选项以包含系统音频

5. **监控推流状态**
   - 页面会显示实时统计信息
   - 日志区域会显示连接过程和状态变化

6. **停止录制**
   - 点击"⏹️ 停止录制"按钮
   - 或者在浏览器的屏幕共享控制栏中点击"停止共享"

### 浏览器兼容性

| 浏览器 | 支持版本 | 说明 |
|--------|----------|------|
| Chrome | 72+ | 完全支持，推荐使用 |
| Edge | 79+ | 完全支持 |
| Firefox | 66+ | 完全支持 |
| Safari | 13+ | 部分支持，可能需要用户手动启用 |
| Opera | 60+ | 完全支持 |

### 配置选项

- **API 地址**: 后端服务的 API 地址（默认 `http://localhost:8080/api/v1`）
- **直播间标题**: 显示在直播间列表中的标题
- **视频编解码器**:
  - VP8: 兼容性好，CPU 编码
  - VP9: 更高压缩率，更好画质
  - H264: 硬件加速支持最好（推荐）
- **视频分辨率**:
  - 480p (640x480)
  - 720p (1280x720) - 推荐
  - 1080p (1920x1080)

### 注意事项

1. **HTTPS 要求**:
   - 屏幕录制 API 要求 HTTPS 连接
   - 本地测试时 `localhost` 除外
   - 生产环境必须使用 HTTPS

2. **权限管理**:
   - 首次使用需要授予屏幕录制权限
   - 某些浏览器会记住权限选择
   - 可以在浏览器设置中撤销权限

3. **系统音频共享**:
   - Chrome/Edge: 支持共享系统音频（Windows/Mac/Linux）
   - Firefox: 仅支持 Windows 系统音频
   - Safari: 不支持系统音频共享

4. **性能考虑**:
   - 高分辨率（1080p）会增加 CPU 使用率
   - 推荐使用 720p 作为默认分辨率
   - H264 编解码器可以利用硬件加速

### 故障排查

#### 无法连接到后端
- 检查后端服务是否运行：`curl http://localhost:8080/health`
- 检查 API 地址配置是否正确
- 查看浏览器控制台的错误信息

#### 屏幕共享权限被拒绝
- 刷新页面重试
- 检查浏览器权限设置
- 确保没有其他程序占用屏幕录制

#### WebRTC 连接失败
- 检查 Ion SFU 容器是否运行
- 检查端口 7100 (gRPC) 是否可访问：`nc -zv localhost 7100`
- 查看后端日志是否有错误信息

#### 视频/音频不流畅
- 降低视频分辨率
- 检查网络带宽
- 查看统计信息中的丢包率和延迟

### 开发调试

打开浏览器开发者工具（F12），可以看到：
- **Console**: 详细的日志输出
- **Network**: WebSocket 连接状态
- **WebRTC internals**:
  - Chrome: `chrome://webrtc-internals`
  - Firefox: `about:webrtc`
  - Edge: `edge://webrtc-internals`

### API 端点

测试页面会调用以下 API 端点：

1. **创建直播间**: `POST /api/v1/live/create`
2. **WebSocket 连接**: `WS /api/v1/live/ws`
3. **开始直播**: `POST /api/v1/live/start`
4. **结束直播**: `POST /api/v1/live/end`

### 与摄像头版本的区别

- ✅ 不需要摄像头和麦克风设备
- ✅ 可以共享整个屏幕、窗口或浏览器标签页
- ✅ 支持系统音频共享
- ✅ 更适合演示、教学、游戏直播场景
- ⚠️ 需要用户手动选择共享内容
- ⚠️ 某些应用程序的窗口可能被保护无法录制

## 未来扩展

- [ ] 添加观众端测试页面
- [ ] 支持同时共享摄像头和屏幕
- [ ] 添加画中画模式
- [ ] 支持录制和下载
- [ ] 添加美颜和滤镜效果
