<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è®¾å¤‡æµ‹è¯• - MicroVibe</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    h1 {
      color: #1f2937;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #6b7280;
      margin-bottom: 30px;
    }

    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f9fafb;
      border-radius: 8px;
    }

    .section h2 {
      color: #1f2937;
      margin-bottom: 15px;
      font-size: 18px;
    }

    video {
      width: 100%;
      max-width: 640px;
      border-radius: 8px;
      background: #000;
      display: block;
      margin: 15px auto;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin: 5px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .device-list {
      list-style: none;
      padding: 0;
    }

    .device-list li {
      padding: 10px;
      margin: 5px 0;
      background: white;
      border-radius: 6px;
      border-left: 3px solid #667eea;
    }

    .device-kind {
      display: inline-block;
      padding: 2px 8px;
      background: #667eea;
      color: white;
      border-radius: 4px;
      font-size: 12px;
      margin-right: 8px;
    }

    .log {
      background: #1f2937;
      color: #e5e7eb;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 13px;
      max-height: 300px;
      overflow-y: auto;
      line-height: 1.8;
    }

    .log-entry {
      margin: 5px 0;
    }

    .log-success { color: #10b981; }
    .log-error { color: #ef4444; }
    .log-info { color: #3b82f6; }

    .constraints {
      background: white;
      padding: 10px;
      border-radius: 6px;
      margin-top: 10px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 12px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¥ è®¾å¤‡æµ‹è¯•å·¥å…·</h1>
    <p class="subtitle">æµ‹è¯•ä½ çš„æ‘„åƒå¤´å’Œéº¦å…‹é£æ˜¯å¦æ­£å¸¸å·¥ä½œ</p>

    <!-- è®¾å¤‡æšä¸¾ -->
    <div class="section">
      <h2>1. æ£€æµ‹å¯ç”¨è®¾å¤‡</h2>
      <button class="btn btn-primary" onclick="enumerateDevices()">ğŸ” æ£€æµ‹è®¾å¤‡</button>
      <ul class="device-list" id="deviceList"></ul>
    </div>

    <!-- åŸºæœ¬æµ‹è¯• -->
    <div class="section">
      <h2>2. åŸºæœ¬åª’ä½“æµæµ‹è¯•ï¼ˆæ— çº¦æŸï¼‰</h2>
      <button class="btn btn-primary" id="basicBtn" onclick="testBasic()">â–¶ï¸ å¯åŠ¨åŸºæœ¬æµ‹è¯•</button>
      <button class="btn btn-primary" id="stopBasicBtn" onclick="stopBasic()" disabled>â¹ï¸ åœæ­¢</button>
      <video id="basicVideo" autoplay muted playsinline></video>
    </div>

    <!-- é«˜æ¸…æµ‹è¯• -->
    <div class="section">
      <h2>3. é«˜æ¸…åª’ä½“æµæµ‹è¯•ï¼ˆ720pï¼‰</h2>
      <button class="btn btn-primary" id="hdBtn" onclick="testHD()">â–¶ï¸ å¯åŠ¨ 720p æµ‹è¯•</button>
      <button class="btn btn-primary" id="stopHdBtn" onclick="stopHD()" disabled>â¹ï¸ åœæ­¢</button>
      <video id="hdVideo" autoplay muted playsinline></video>
      <div class="constraints" id="hdConstraints"></div>
    </div>

    <!-- æ—¥å¿— -->
    <div class="section">
      <h2>ğŸ“‹ æ—¥å¿—</h2>
      <div class="log" id="log"></div>
    </div>
  </div>

  <script>
    let basicStream = null;
    let hdStream = null;

    // æ—¥å¿—è¾“å‡º
    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      const className = `log-${type}`;
      const entry = document.createElement('div');
      entry.className = `log-entry ${className}`;
      entry.textContent = `[${time}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    }

    // æšä¸¾è®¾å¤‡
    async function enumerateDevices() {
      try {
        log('æ­£åœ¨æ£€æµ‹è®¾å¤‡...', 'info');

        // å…ˆè¯·æ±‚æƒé™ï¼Œå¦åˆ™ enumerateDevices å¯èƒ½è¿”å›ç©ºæ ‡ç­¾
        try {
          const tempStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
          tempStream.getTracks().forEach(track => track.stop());
          log('âœ… å·²è·å–è®¾å¤‡æƒé™', 'success');
        } catch (err) {
          log('âš ï¸ æ— æ³•è·å–è®¾å¤‡æƒé™ï¼Œè®¾å¤‡ä¿¡æ¯å¯èƒ½ä¸å®Œæ•´', 'error');
        }

        const devices = await navigator.mediaDevices.enumerateDevices();
        log(`æ£€æµ‹åˆ° ${devices.length} ä¸ªè®¾å¤‡`, 'info');

        const listDiv = document.getElementById('deviceList');
        listDiv.innerHTML = '';

        let videoCount = 0, audioInCount = 0, audioOutCount = 0;

        devices.forEach((device, index) => {
          const li = document.createElement('li');
          let kindLabel = '';

          if (device.kind === 'videoinput') {
            kindLabel = 'ğŸ“¹ æ‘„åƒå¤´';
            videoCount++;
          } else if (device.kind === 'audioinput') {
            kindLabel = 'ğŸ¤ éº¦å…‹é£';
            audioInCount++;
          } else if (device.kind === 'audiooutput') {
            kindLabel = 'ğŸ”Š æ‰¬å£°å™¨';
            audioOutCount++;
          }

          const label = device.label || `${kindLabel} ${index + 1}`;
          li.innerHTML = `<span class="device-kind">${kindLabel}</span>${label}`;
          listDiv.appendChild(li);
        });

        log(`âœ… æ£€æµ‹å®Œæˆ: ${videoCount} ä¸ªæ‘„åƒå¤´, ${audioInCount} ä¸ªéº¦å…‹é£, ${audioOutCount} ä¸ªæ‰¬å£°å™¨`, 'success');

        if (videoCount === 0 && audioInCount === 0) {
          log('âŒ è­¦å‘Š: æœªæ£€æµ‹åˆ°ä»»ä½•è¾“å…¥è®¾å¤‡ï¼', 'error');
        }

      } catch (error) {
        log(`âŒ è®¾å¤‡æ£€æµ‹å¤±è´¥: ${error.message}`, 'error');
        console.error(error);
      }
    }

    // åŸºæœ¬æµ‹è¯•
    async function testBasic() {
      try {
        log('æ­£åœ¨å¯åŠ¨åŸºæœ¬æµ‹è¯•ï¼ˆæ— çº¦æŸï¼‰...', 'info');
        document.getElementById('basicBtn').disabled = true;

        basicStream = await navigator.mediaDevices.getUserMedia({
          video: true,
          audio: true
        });

        document.getElementById('basicVideo').srcObject = basicStream;
        document.getElementById('stopBasicBtn').disabled = false;

        const videoTrack = basicStream.getVideoTracks()[0];
        const audioTrack = basicStream.getAudioTracks()[0];
        const settings = videoTrack.getSettings();

        log(`âœ… åŸºæœ¬æµ‹è¯•æˆåŠŸï¼`, 'success');
        log(`è§†é¢‘: ${settings.width}x${settings.height} @ ${settings.frameRate}fps`, 'info');
        log(`éŸ³é¢‘: ${audioTrack.label}`, 'info');

      } catch (error) {
        log(`âŒ åŸºæœ¬æµ‹è¯•å¤±è´¥: ${error.name} - ${error.message}`, 'error');
        console.error(error);
        document.getElementById('basicBtn').disabled = false;
      }
    }

    function stopBasic() {
      if (basicStream) {
        basicStream.getTracks().forEach(track => track.stop());
        basicStream = null;
        document.getElementById('basicVideo').srcObject = null;
        document.getElementById('basicBtn').disabled = false;
        document.getElementById('stopBasicBtn').disabled = true;
        log('åŸºæœ¬æµ‹è¯•å·²åœæ­¢', 'info');
      }
    }

    // é«˜æ¸…æµ‹è¯•
    async function testHD() {
      try {
        log('æ­£åœ¨å¯åŠ¨ 720p æµ‹è¯•...', 'info');
        document.getElementById('hdBtn').disabled = true;

        const constraints = {
          video: {
            width: { ideal: 1280 },
            height: { ideal: 720 },
            frameRate: { ideal: 30 }
          },
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true
          }
        };

        document.getElementById('hdConstraints').textContent =
          'Constraints:\n' + JSON.stringify(constraints, null, 2);

        hdStream = await navigator.mediaDevices.getUserMedia(constraints);

        document.getElementById('hdVideo').srcObject = hdStream;
        document.getElementById('stopHdBtn').disabled = false;

        const videoTrack = hdStream.getVideoTracks()[0];
        const audioTrack = hdStream.getAudioTracks()[0];
        const settings = videoTrack.getSettings();
        const capabilities = videoTrack.getCapabilities();

        log(`âœ… 720p æµ‹è¯•æˆåŠŸï¼`, 'success');
        log(`å®é™…åˆ†è¾¨ç‡: ${settings.width}x${settings.height} @ ${settings.frameRate}fps`, 'info');
        log(`æ”¯æŒåˆ†è¾¨ç‡èŒƒå›´: ${capabilities.width.min}-${capabilities.width.max} x ${capabilities.height.min}-${capabilities.height.max}`, 'info');
        log(`éŸ³é¢‘: ${audioTrack.label}`, 'info');

      } catch (error) {
        log(`âŒ 720p æµ‹è¯•å¤±è´¥: ${error.name} - ${error.message}`, 'error');

        if (error.name === 'OverconstrainedError') {
          log('å°è¯•é™çº§åˆ°è¾ƒä½åˆ†è¾¨ç‡...', 'info');
          try {
            hdStream = await navigator.mediaDevices.getUserMedia({
              video: { width: { ideal: 640 }, height: { ideal: 480 } },
              audio: true
            });
            document.getElementById('hdVideo').srcObject = hdStream;
            document.getElementById('stopHdBtn').disabled = false;
            log('âœ… é™çº§åˆ° VGA (640x480) æˆåŠŸ', 'success');
          } catch (fallbackError) {
            log(`âŒ é™çº§ä¹Ÿå¤±è´¥äº†: ${fallbackError.message}`, 'error');
            document.getElementById('hdBtn').disabled = false;
          }
        } else {
          console.error(error);
          document.getElementById('hdBtn').disabled = false;
        }
      }
    }

    function stopHD() {
      if (hdStream) {
        hdStream.getTracks().forEach(track => track.stop());
        hdStream = null;
        document.getElementById('hdVideo').srcObject = null;
        document.getElementById('hdBtn').disabled = false;
        document.getElementById('stopHdBtn').disabled = true;
        log('720p æµ‹è¯•å·²åœæ­¢', 'info');
      }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æµ‹è®¾å¤‡
    window.addEventListener('load', () => {
      log('è®¾å¤‡æµ‹è¯•å·¥å…·å·²åŠ è½½', 'info');
      log('è¯·ç‚¹å‡»"æ£€æµ‹è®¾å¤‡"å¼€å§‹æµ‹è¯•', 'info');
    });
  </script>
</body>
</html>
