# Pre-commit Hooks ä½¿ç”¨æŒ‡å—

æœ¬é¡¹ç›®ä½¿ç”¨ [pre-commit](https://pre-commit.com/) æ¡†æ¶æ¥ç¡®ä¿ä»£ç è´¨é‡å’Œæäº¤è§„èŒƒã€‚

## ğŸ“‹ ç›®å½•

- [åŠŸèƒ½ç‰¹æ€§](#åŠŸèƒ½ç‰¹æ€§)
- [å®‰è£…é…ç½®](#å®‰è£…é…ç½®)
- [ä½¿ç”¨è¯´æ˜](#ä½¿ç”¨è¯´æ˜)
- [æäº¤è§„èŒƒ](#æäº¤è§„èŒƒ)
- [é’©å­è¯´æ˜](#é’©å­è¯´æ˜)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

## âœ¨ åŠŸèƒ½ç‰¹æ€§

pre-commit ä¼šåœ¨æ¯æ¬¡ Git æäº¤å‰è‡ªåŠ¨æ‰§è¡Œä»¥ä¸‹æ£€æŸ¥ï¼š

### 1. é€šç”¨æ£€æŸ¥
- âœ… ç§»é™¤æ–‡ä»¶æœ«å°¾çš„ç©ºç™½å­—ç¬¦
- âœ… ç¡®ä¿æ–‡ä»¶ä»¥æ¢è¡Œç¬¦ç»“å°¾
- âœ… éªŒè¯ YAML æ–‡ä»¶æ ¼å¼
- âœ… éªŒè¯ JSON æ–‡ä»¶æ ¼å¼
- âœ… æ£€æŸ¥æ˜¯å¦åŒ…å«å¤§æ–‡ä»¶ï¼ˆ>1MBï¼‰
- âœ… æ£€æŸ¥æ˜¯å¦åŒ…å«åˆå¹¶å†²çªæ ‡è®°
- âœ… æ£€æµ‹ç§é’¥æ³„éœ²
- âœ… ç»Ÿä¸€æ¢è¡Œç¬¦ä¸º LF

### 2. Go ä»£ç æ£€æŸ¥
- âœ… `go fmt` - è‡ªåŠ¨æ ¼å¼åŒ–ä»£ç 
- âœ… `go imports` - è‡ªåŠ¨æ•´ç†å¯¼å…¥è¯­å¥
- âœ… `go vet` - é™æ€ä»£ç åˆ†æ
- âœ… `go mod tidy` - æ¸…ç† go.mod å’Œ go.sum
- âœ… `go build` - ç¡®ä¿ä»£ç å¯ç¼–è¯‘

### 3. æäº¤ä¿¡æ¯è§„èŒƒ
- âœ… å¼ºåˆ¶ä½¿ç”¨ Conventional Commits è§„èŒƒ

## ğŸš€ å®‰è£…é…ç½®

### 1. å®‰è£… pre-commit

**macOS (Homebrew):**
```bash
brew install pre-commit
```

**Linux (pip):**
```bash
pip install pre-commit
```

**éªŒè¯å®‰è£…:**
```bash
pre-commit --version
```

### 2. å®‰è£… Git Hooks

åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œï¼š

```bash
make pre-commit-install
```

æˆ–è€…æ‰‹åŠ¨æ‰§è¡Œï¼š

```bash
pre-commit install --install-hooks
pre-commit install --hook-type commit-msg
```

å®‰è£…æˆåŠŸåï¼Œæ¯æ¬¡ `git commit` éƒ½ä¼šè‡ªåŠ¨è§¦å‘æ£€æŸ¥ã€‚

### 3. éªŒè¯é…ç½®

æ‰‹åŠ¨è¿è¡Œæ£€æŸ¥æ‰€æœ‰æ–‡ä»¶ï¼š

```bash
make pre-commit-run
```

æˆ–è€…ï¼š

```bash
pre-commit run --all-files
```

## ğŸ“– ä½¿ç”¨è¯´æ˜

### æ­£å¸¸æäº¤æµç¨‹

1. **ä¿®æ”¹ä»£ç å¹¶æš‚å­˜**
   ```bash
   git add .
   ```

2. **æ‰§è¡Œæäº¤ï¼ˆè‡ªåŠ¨è§¦å‘ pre-commitï¼‰**
   ```bash
   git commit -m "feat: æ·»åŠ ç”¨æˆ·è®¤è¯åŠŸèƒ½"
   ```

3. **å¦‚æœæ£€æŸ¥é€šè¿‡ï¼Œæäº¤æˆåŠŸ**
   ```
   âœ… æ‰€æœ‰é’©å­é€šè¿‡
   æäº¤æˆåŠŸï¼
   ```

4. **å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œä¿®å¤åé‡æ–°æäº¤**
   ```
   âŒ go-fmt.....................................................Failed
   æ–‡ä»¶å·²è‡ªåŠ¨ä¿®å¤ï¼Œè¯·é‡æ–°æäº¤
   ```

### è·³è¿‡é’©å­ï¼ˆä¸æ¨èï¼‰

åœ¨ç´§æ€¥æƒ…å†µä¸‹å¯ä»¥è·³è¿‡æ£€æŸ¥ï¼š

```bash
git commit --no-verify -m "æäº¤ä¿¡æ¯"
```

**æ³¨æ„ï¼š** ä¸æ¨èè·³è¿‡æ£€æŸ¥ï¼Œè¿™ä¼šé™ä½ä»£ç è´¨é‡ï¼

### æ‰‹åŠ¨è¿è¡Œæ£€æŸ¥

**æ£€æŸ¥æ‰€æœ‰æ–‡ä»¶:**
```bash
pre-commit run --all-files
```

**æ£€æŸ¥ç‰¹å®šæ–‡ä»¶:**
```bash
pre-commit run --files cmd/server/main.go
```

**åªè¿è¡Œç‰¹å®šé’©å­:**
```bash
pre-commit run go-fmt --all-files
pre-commit run go-vet --all-files
```

## ğŸ“ æäº¤è§„èŒƒ

æœ¬é¡¹ç›®ä½¿ç”¨ **å¸¦ Emoji çš„ Conventional Commits** è§„èŒƒï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

```
emoji type: subject

- change 1
- change 2
- change 3
```

### å¿…å¡«éƒ¨åˆ†

- **emoji**: è¡¨ç¤ºæäº¤ç±»å‹çš„ emojiï¼ˆå¿…å¡«ï¼‰
- **type**: æäº¤ç±»å‹ï¼ˆå¿…å¡«ï¼‰
- **subject**: ç®€çŸ­æè¿°ï¼ˆå¿…å¡«ï¼Œä¸è¶…è¿‡ 72 å­—ç¬¦ï¼‰
- **body**: è¯¦ç»†ä¿®æ”¹åˆ—è¡¨ï¼ˆå¯é€‰ï¼Œä½¿ç”¨ `-` å¼€å¤´ï¼‰

### Emoji å’Œ Type å¯¹ç…§è¡¨

| Emoji | Type | è¯´æ˜ | å®Œæ•´ç¤ºä¾‹ |
|-------|------|------|----------|
| âœ¨ | `feat` | æ–°åŠŸèƒ½ | `âœ¨ feat: æ·»åŠ ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½` |
| ğŸ› | `fix` | Bug ä¿®å¤ | `ğŸ› fix: ä¿®å¤ç™»å½•éªŒè¯é”™è¯¯` |
| ğŸ“ | `docs` | æ–‡æ¡£æ›´æ–° | `ğŸ“ docs: æ›´æ–° API æ–‡æ¡£` |
| ğŸ’„ | `style` | ä»£ç æ ¼å¼ | `ğŸ’„ style: æ ¼å¼åŒ–ä»£ç ` |
| â™»ï¸ | `refactor` | é‡æ„ | `â™»ï¸ refactor: é‡æ„ç”¨æˆ·æœåŠ¡å±‚` |
| âš¡ | `perf` | æ€§èƒ½ä¼˜åŒ– | `âš¡ perf: ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢` |
| âœ… | `test` | æµ‹è¯• | `âœ… test: æ·»åŠ ç”¨æˆ·æœåŠ¡å•å…ƒæµ‹è¯•` |
| ğŸ“¦ | `build` | æ„å»º/ä¾èµ– | `ğŸ“¦ build: å‡çº§ gin åˆ° v1.9.0` |
| ğŸ‘· | `ci` | CI/CD | `ğŸ‘· ci: æ·»åŠ  GitHub Actions` |
| ğŸ”§ | `chore` | å…¶ä»–æ‚é¡¹ | `ğŸ”§ chore: æ›´æ–° .gitignore` |
| âª | `revert` | å›æ»šæäº¤ | `âª revert: å›æ»š feat: xxx` |

### æäº¤ç¤ºä¾‹

**âœ… æ­£ç¡®ç¤ºä¾‹:**
```bash
git commit -m "âœ¨ feat: æ·»åŠ è§†é¢‘æ¨èç®—æ³•"

git commit -m "ğŸ› fix: ä¿®å¤è¯„è®ºç‚¹èµé‡å¤é—®é¢˜"

git commit -m "ğŸ“ docs: æ›´æ–°ç¼“å­˜æ¡†æ¶ä½¿ç”¨æ–‡æ¡£"

git commit -m "â™»ï¸ refactor: ä¼˜åŒ–ç›´æ’­äº‹ä»¶å¤„ç†é€»è¾‘"

git commit -m "âš¡ perf: ä½¿ç”¨ Redis ç¼“å­˜çƒ­é—¨è§†é¢‘åˆ—è¡¨"
```

**âŒ é”™è¯¯ç¤ºä¾‹:**
```bash
git commit -m "æ›´æ–°ä»£ç "              # âŒ ç¼ºå°‘ emoji å’Œ type
git commit -m "feat: æ·»åŠ åŠŸèƒ½"        # âŒ ç¼ºå°‘ emoji
git commit -m "âœ¨ æ·»åŠ åŠŸèƒ½"           # âŒ ç¼ºå°‘ type
git commit -m "âœ¨ add feature"       # âŒ subject åº”ä½¿ç”¨ä¸­æ–‡
```

### å®Œæ•´æäº¤ç¤ºä¾‹ï¼ˆå¸¦è¯¦ç»†ä¿®æ”¹åˆ—è¡¨ï¼‰

```bash
git commit -m "âœ¨ feat: æ·»åŠ ç›´æ’­é—´ç¤¼ç‰©åŠŸèƒ½

- æ·»åŠ ç¤¼ç‰©æ¨¡å‹å’Œæ•°æ®è¡¨
- å®ç°ç¤¼ç‰©å‘é€å’Œæ¥æ”¶æ¥å£
- é›†æˆæ”¯ä»˜æ‰£æ¬¾é€»è¾‘
- æ·»åŠ ç¤¼ç‰©ç»Ÿè®¡åŠŸèƒ½"
```

**å®é™…æ“ä½œï¼ˆä½¿ç”¨ç¼–è¾‘å™¨ï¼‰:**
```bash
git add .
git commit
```

ç„¶ååœ¨ç¼–è¾‘å™¨ä¸­è¾“å…¥ï¼š
```
âœ¨ feat: æ·»åŠ ç›´æ’­é—´ç¤¼ç‰©åŠŸèƒ½

- æ·»åŠ ç¤¼ç‰©æ¨¡å‹å’Œæ•°æ®è¡¨
- å®ç°ç¤¼ç‰©å‘é€å’Œæ¥æ”¶æ¥å£
- é›†æˆæ”¯ä»˜æ‰£æ¬¾é€»è¾‘
- æ·»åŠ ç¤¼ç‰©ç»Ÿè®¡åŠŸèƒ½
```

## ğŸ”§ é’©å­è¯´æ˜

### æ–‡ä»¶ä¿®å¤ç±»é’©å­

è¿™äº›é’©å­ä¼š**è‡ªåŠ¨ä¿®å¤**æ–‡ä»¶ï¼š

- `trailing-whitespace`: è‡ªåŠ¨åˆ é™¤è¡Œå°¾ç©ºç™½
- `end-of-file-fixer`: è‡ªåŠ¨æ·»åŠ æ–‡ä»¶æœ«å°¾æ¢è¡Œç¬¦
- `mixed-line-ending`: ç»Ÿä¸€æ¢è¡Œç¬¦ä¸º LF
- `go-fmt`: è‡ªåŠ¨æ ¼å¼åŒ– Go ä»£ç 
- `go-imports`: è‡ªåŠ¨æ•´ç†å¯¼å…¥è¯­å¥
- `go-mod-tidy`: è‡ªåŠ¨æ¸…ç† go.mod

**å¤„ç†æ–¹å¼:**
æ–‡ä»¶è¢«ä¿®å¤åï¼Œéœ€è¦é‡æ–°æ·»åŠ å¹¶æäº¤ï¼š

```bash
git add .
git commit -m "feat: xxx"  # å†æ¬¡æäº¤
```

### æ£€æŸ¥ç±»é’©å­

è¿™äº›é’©å­åª**æ£€æŸ¥**ï¼Œä¸ä¼šä¿®æ”¹æ–‡ä»¶ï¼š

- `go-vet`: æ£€æŸ¥ä»£ç é—®é¢˜
- `go-build`: æ£€æŸ¥æ˜¯å¦å¯ç¼–è¯‘
- `check-yaml/json`: æ£€æŸ¥æ–‡ä»¶æ ¼å¼
- `check-added-large-files`: æ£€æŸ¥å¤§æ–‡ä»¶
- `detect-private-key`: æ£€æŸ¥ç§é’¥æ³„éœ²

**å¤„ç†æ–¹å¼:**
éœ€è¦æ‰‹åŠ¨ä¿®å¤é”™è¯¯åé‡æ–°æäº¤ã€‚

### æäº¤ä¿¡æ¯é’©å­

- `conventional-pre-commit`: éªŒè¯æäº¤ä¿¡æ¯æ ¼å¼

**å¤„ç†æ–¹å¼:**
ä¿®æ”¹æäº¤ä¿¡æ¯æ ¼å¼åé‡æ–°æäº¤ã€‚

## â“ å¸¸è§é—®é¢˜

### 1. pre-commit å®‰è£…å¤±è´¥

**é—®é¢˜:** `command not found: pre-commit`

**è§£å†³:**
```bash
# macOS
brew install pre-commit

# Linux
pip install pre-commit

# æˆ–ä½¿ç”¨ Python pip
python3 -m pip install pre-commit
```

### 2. é’©å­å®‰è£…å¤±è´¥

**é—®é¢˜:** `An error has occurred: InvalidManifestError`

**è§£å†³:**
```bash
# æ¸…ç†ç¼“å­˜åé‡æ–°å®‰è£…
pre-commit clean
pre-commit install --install-hooks
```

### 3. go-build å¤±è´¥

**é—®é¢˜:** `go-build.....Failed`

**è§£å†³:**
ç¡®ä¿ä»£ç å¯ä»¥æ­£å¸¸ç¼–è¯‘ï¼š

```bash
# æ‰‹åŠ¨æµ‹è¯•ç¼–è¯‘
make build

# æˆ–
go build -o main cmd/server/main.go
```

ä¿®å¤ç¼–è¯‘é”™è¯¯åé‡æ–°æäº¤ã€‚

### 4. æäº¤ä¿¡æ¯æ ¼å¼é”™è¯¯

**é—®é¢˜:** `[conventional-pre-commit] Commit message does not follow Conventional Commits`

**è§£å†³:**
ä¿®æ”¹æäº¤ä¿¡æ¯ä¸ºæ­£ç¡®æ ¼å¼ï¼š

```bash
# é”™è¯¯
git commit -m "æ·»åŠ åŠŸèƒ½"

# æ­£ç¡®
git commit -m "feat: æ·»åŠ ç”¨æˆ·è®¤è¯åŠŸèƒ½"
```

### 5. è·³è¿‡ç‰¹å®šé’©å­

å¦‚æœæŸä¸ªé’©å­æœ‰é—®é¢˜ï¼Œå¯ä»¥ä¸´æ—¶è·³è¿‡ï¼š

```bash
# è·³è¿‡æ‰€æœ‰é’©å­
SKIP=all git commit -m "feat: xxx"

# è·³è¿‡ç‰¹å®šé’©å­
SKIP=go-build git commit -m "feat: xxx"

# è·³è¿‡å¤šä¸ªé’©å­
SKIP=go-build,go-vet git commit -m "feat: xxx"
```

### 6. æ›´æ–°é’©å­

**é—®é¢˜:** é…ç½®æ–‡ä»¶æ›´æ–°åï¼Œå¦‚ä½•åº”ç”¨ï¼Ÿ

**è§£å†³:**
```bash
# é‡æ–°å®‰è£…é’©å­
pre-commit install --install-hooks --overwrite

# æˆ–ä½¿ç”¨ autoupdate è‡ªåŠ¨æ›´æ–°
pre-commit autoupdate
```

### 7. æŸ¥çœ‹é’©å­æ—¥å¿—

**é—®é¢˜:** é’©å­å¤±è´¥ä½†ä¸çŸ¥é“å…·ä½“åŸå› 

**è§£å†³:**
```bash
# å¯ç”¨è¯¦ç»†è¾“å‡º
pre-commit run --all-files --verbose
```

## ğŸ“š æ›´å¤šèµ„æº

- [Pre-commit å®˜æ–¹æ–‡æ¡£](https://pre-commit.com/)
- [Conventional Commits è§„èŒƒ](https://www.conventionalcommits.org/)
- [Go pre-commit hooks](https://github.com/dnephin/pre-commit-golang)
- [Pre-commit hooks åˆ—è¡¨](https://pre-commit.com/hooks.html)

## ğŸ”„ æ›´æ–°é…ç½®

é…ç½®æ–‡ä»¶ä½äº `.pre-commit-config.yaml`ï¼Œä¿®æ”¹åéœ€è¦é‡æ–°å®‰è£…ï¼š

```bash
pre-commit install --install-hooks --overwrite
```

è‡ªåŠ¨æ›´æ–°é’©å­ç‰ˆæœ¬ï¼š

```bash
pre-commit autoupdate
```

## ğŸ’¡ æœ€ä½³å®è·µ

1. **æäº¤å‰å…ˆè¿è¡Œæ£€æŸ¥:** `make pre-commit-run`
2. **éµå®ˆæäº¤è§„èŒƒ:** ä½¿ç”¨ `feat/fix/docs` ç­‰å‰ç¼€
3. **ä¿æŒæäº¤åŸå­æ€§:** æ¯æ¬¡æäº¤åªåšä¸€ä»¶äº‹
4. **ä¸è¦è·³è¿‡é’©å­:** é™¤éç´§æ€¥æƒ…å†µ
5. **å®šæœŸæ›´æ–°é’©å­:** `pre-commit autoupdate`
6. **å›¢é˜Ÿç»Ÿä¸€é…ç½®:** æ‰€æœ‰æˆå‘˜ä½¿ç”¨ç›¸åŒé…ç½®

## ğŸ“ æ”¯æŒ

é‡åˆ°é—®é¢˜ï¼Ÿ

1. æŸ¥çœ‹æœ¬æ–‡æ¡£çš„ [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜) éƒ¨åˆ†
2. æŸ¥çœ‹ [Pre-commit å®˜æ–¹æ–‡æ¡£](https://pre-commit.com/)
3. æäº¤ Issue åˆ°é¡¹ç›®ä»“åº“
